════════════════════════════════════════════════════════════════════════════════
           ERD ДИАГРАММА ИНФОРМАЦИОННОЙ СИСТЕМЫ "CAR LAB"
                    (Entity-Relationship Diagram)
════════════════════════════════════════════════════════════════════════════════

┌──────────────────────────────────────────────────────────────────────────────┐
│                       СТРУКТУРА БАЗЫ ДАННЫХ (6 ТАБЛИЦ)                      │
└──────────────────────────────────────────────────────────────────────────────┘

╔════════════════════════════════════════════════════════════════════════════╗
║                            1. USERS (Пользователи)                         ║
╠════════════════════════════════════════════════════════════════════════════╣
║ Назначение: Хранение информации о сотрудниках автосервиса                 ║
╠════════════════════════════════════════════════════════════════════════════╣
║ ПОЛЕ                  │ ТИП         │ ОПИСАНИЕ                             ║
╟───────────────────────┼─────────────┼──────────────────────────────────────╢
║ id                 PK │ UUID        │ Уникальный идентификатор             ║
║ email              UK │ VARCHAR     │ Email для входа (уникальный)         ║
║ password_hash         │ VARCHAR     │ Хэш пароля (bcrypt)                  ║
║ full_name             │ VARCHAR     │ ФИО сотрудника                       ║
║ role                  │ VARCHAR     │ Роль (admin, master)                 ║
║ created_at            │ TIMESTAMP   │ Дата создания записи                 ║
╚═══════════════════════╧═════════════╧══════════════════════════════════════╝

╔════════════════════════════════════════════════════════════════════════════╗
║                          2. CLIENTS (Клиенты)                              ║
╠════════════════════════════════════════════════════════════════════════════╣
║ Назначение: Информация о клиентах автосервиса                             ║
╠════════════════════════════════════════════════════════════════════════════╣
║ ПОЛЕ                  │ ТИП         │ ОПИСАНИЕ                             ║
╟───────────────────────┼─────────────┼──────────────────────────────────────╢
║ id                 PK │ UUID        │ Уникальный идентификатор             ║
║ first_name            │ VARCHAR     │ Имя клиента                          ║
║ last_name             │ VARCHAR     │ Фамилия клиента (опционально)        ║
║ phone                 │ VARCHAR     │ Номер телефона                       ║
║ email                 │ VARCHAR     │ Email (опционально)                  ║
║ created_at            │ TIMESTAMP   │ Дата регистрации                     ║
╚═══════════════════════╧═════════════╧══════════════════════════════════════╝

╔════════════════════════════════════════════════════════════════════════════╗
║                        3. VEHICLES (Автомобили)                            ║
╠════════════════════════════════════════════════════════════════════════════╣
║ Назначение: Информация об автомобилях клиентов                            ║
╠════════════════════════════════════════════════════════════════════════════╣
║ ПОЛЕ                  │ ТИП         │ ОПИСАНИЕ                             ║
╟───────────────────────┼─────────────┼──────────────────────────────────────╢
║ id                 PK │ UUID        │ Уникальный идентификатор             ║
║ client_id          FK │ UUID        │ → CLIENTS.id                         ║
║ brand                 │ VARCHAR     │ Марка автомобиля                     ║
║ model                 │ VARCHAR     │ Модель автомобиля                    ║
║ year                  │ INT         │ Год выпуска                          ║
║ vin                   │ VARCHAR     │ VIN-номер                            ║
║ license_plate         │ VARCHAR     │ Государственный номер                ║
║ created_at            │ TIMESTAMP   │ Дата добавления                      ║
╠═══════════════════════╧═════════════╧══════════════════════════════════════╣
║ ИНДЕКСЫ: client_id                                                         ║
╚════════════════════════════════════════════════════════════════════════════╝

╔════════════════════════════════════════════════════════════════════════════╗
║                  4. SERVICE_REQUESTS (Заявки на обслуживание)              ║
╠════════════════════════════════════════════════════════════════════════════╣
║ Назначение: Основная сущность - заявки на ремонт/обслуживание             ║
╠════════════════════════════════════════════════════════════════════════════╣
║ ПОЛЕ                  │ ТИП         │ ОПИСАНИЕ                             ║
╟───────────────────────┼─────────────┼──────────────────────────────────────╢
║ id                 PK │ UUID        │ Уникальный идентификатор             ║
║ request_number     UK │ VARCHAR     │ Номер заявки (REQ-XXXXXX)            ║
║ tracking_token     UK │ VARCHAR     │ Токен для отслеживания клиентом      ║
║ client_id          FK │ UUID        │ → CLIENTS.id                         ║
║ vehicle_id         FK │ UUID        │ → VEHICLES.id                        ║
║ description           │ TEXT        │ Описание проблемы                    ║
║ status                │ VARCHAR     │ new, in_progress, completed, etc.    ║
║ assigned_master       │ VARCHAR     │ ФИО назначенного мастера             ║
║ progress_percentage   │ INT         │ Процент выполнения (0-100)           ║
║ total_amount          │ DECIMAL(10,2)│ Общая стоимость работ               ║
║ payment_status        │ VARCHAR     │ paid, unpaid                         ║
║ estimated_completion  │ TIMESTAMP   │ Планируемая дата завершения          ║
║ created_at            │ TIMESTAMP   │ Дата создания заявки                 ║
║ updated_at            │ TIMESTAMP   │ Дата последнего обновления           ║
╠═══════════════════════╧═════════════╧══════════════════════════════════════╣
║ ИНДЕКСЫ: status, request_number, tracking_token, client_id                ║
╚════════════════════════════════════════════════════════════════════════════╝

╔════════════════════════════════════════════════════════════════════════════╗
║                    5. REQUEST_WORKS (Работы по заявке)                     ║
╠════════════════════════════════════════════════════════════════════════════╣
║ Назначение: Список выполняемых работ и услуг по каждой заявке             ║
╠════════════════════════════════════════════════════════════════════════════╣
║ ПОЛЕ                  │ ТИП         │ ОПИСАНИЕ                             ║
╟───────────────────────┼─────────────┼──────────────────────────────────────╢
║ id                 PK │ UUID        │ Уникальный идентификатор             ║
║ request_id         FK │ UUID        │ → SERVICE_REQUESTS.id (CASCADE)      ║
║ work_name             │ VARCHAR     │ Название работы/услуги               ║
║ quantity              │ DECIMAL(10,2)│ Количество                          ║
║ unit_price            │ DECIMAL(10,2)│ Цена за единицу                     ║
║ total_price           │ DECIMAL(10,2)│ Общая стоимость                     ║
║ created_at            │ TIMESTAMP   │ Дата добавления                      ║
╠═══════════════════════╧═════════════╧══════════════════════════════════════╣
║ ИНДЕКСЫ: request_id                                                        ║
║ КАСКАДНОЕ УДАЛЕНИЕ: При удалении заявки удаляются все работы              ║
╚════════════════════════════════════════════════════════════════════════════╝

╔════════════════════════════════════════════════════════════════════════════╗
║              6. REQUEST_STATUS_HISTORY (История изменения статусов)        ║
╠════════════════════════════════════════════════════════════════════════════╣
║ Назначение: Аудит изменений статуса заявок                                ║
╠════════════════════════════════════════════════════════════════════════════╣
║ ПОЛЕ                  │ ТИП         │ ОПИСАНИЕ                             ║
╟───────────────────────┼─────────────┼──────────────────────────────────────╢
║ id                 PK │ UUID        │ Уникальный идентификатор             ║
║ request_id         FK │ UUID        │ → SERVICE_REQUESTS.id (CASCADE)      ║
║ old_status            │ VARCHAR     │ Предыдущий статус                    ║
║ new_status            │ VARCHAR     │ Новый статус                         ║
║ changed_by         FK │ UUID        │ → USERS.id (опционально)             ║
║ created_at            │ TIMESTAMP   │ Дата и время изменения               ║
╠═══════════════════════╧═════════════╧══════════════════════════════════════╣
║ ИНДЕКСЫ: request_id                                                        ║
║ КАСКАДНОЕ УДАЛЕНИЕ: При удалении заявки удаляется вся история             ║
╚════════════════════════════════════════════════════════════════════════════╝


┌──────────────────────────────────────────────────────────────────────────────┐
│                           СВЯЗИ МЕЖДУ ТАБЛИЦАМИ                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. CLIENTS ──── VEHICLES (Один ко многим)                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│ • Один клиент может владеть несколькими автомобилями                        │
│ • Каждый автомобиль принадлежит одному клиенту                              │
│ • Связь: VEHICLES.client_id → CLIENTS.id                                    │
│ • Индекс на client_id для быстрого поиска автомобилей клиента               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. CLIENTS ──── SERVICE_REQUESTS (Один ко многим)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ • Один клиент может создать множество заявок                                │
│ • Каждая заявка принадлежит одному клиенту                                  │
│ • Связь: SERVICE_REQUESTS.client_id → CLIENTS.id                            │
│ • Индекс на client_id для быстрого поиска заявок клиента                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. VEHICLES ──── SERVICE_REQUESTS (Один ко многим)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ • Один автомобиль может иметь множество заявок на обслуживание              │
│ • Каждая заявка относится к одному автомобилю                               │
│ • Связь: SERVICE_REQUESTS.vehicle_id → VEHICLES.id                          │
│ • Позволяет отслеживать историю обслуживания автомобиля                     │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. SERVICE_REQUESTS ──── REQUEST_WORKS (Один ко многим)                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ • Одна заявка может содержать множество работ/услуг                         │
│ • Каждая работа относится к одной заявке                                    │
│ • Связь: REQUEST_WORKS.request_id → SERVICE_REQUESTS.id                     │
│ • КАСКАДНОЕ УДАЛЕНИЕ: При удалении заявки удаляются все работы              │
│ • Используется для формирования сметы и расчета total_amount                │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 5. SERVICE_REQUESTS ──── REQUEST_STATUS_HISTORY (Один ко многим)            │
├─────────────────────────────────────────────────────────────────────────────┤
│ • Одна заявка имеет множество записей истории изменения статуса             │
│ • Каждая запись истории относится к одной заявке                            │
│ • Связь: REQUEST_STATUS_HISTORY.request_id → SERVICE_REQUESTS.id            │
│ • КАСКАДНОЕ УДАЛЕНИЕ: При удалении заявки удаляется история                 │
│ • Используется для аудита и отслеживания прогресса                          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 6. USERS ──── REQUEST_STATUS_HISTORY (Один ко многим)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│ • Один пользователь может изменять статусы множества заявок                 │
│ • Каждое изменение статуса может быть связано с пользователем               │
│ • Связь: REQUEST_STATUS_HISTORY.changed_by → USERS.id (опционально)         │
│ • Используется для отслеживания ответственности за изменения                │
└─────────────────────────────────────────────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────────┐
│                        КЛЮЧЕВЫЕ ХАРАКТЕРИСТИКИ БД                            │
└──────────────────────────────────────────────────────────────────────────────┘

╔═══════════════════════════════════════════════════════════════════════════╗
║ ПЕРВИЧНЫЕ КЛЮЧИ (Primary Keys)                                           ║
╠═══════════════════════════════════════════════════════════════════════════╣
║ Все таблицы используют UUID в качестве первичного ключа (поле id)        ║
║ Преимущества:                                                             ║
║ • Глобальная уникальность без координации между серверами                 ║
║ • Невозможность предсказать ID следующей записи (безопасность)            ║
║ • Удобство при миграции и репликации данных                               ║
╚═══════════════════════════════════════════════════════════════════════════╝

╔═══════════════════════════════════════════════════════════════════════════╗
║ УНИКАЛЬНЫЕ КЛЮЧИ (Unique Keys)                                            ║
╠═══════════════════════════════════════════════════════════════════════════╣
║ • USERS.email                - Уникальный email для входа                 ║
║ • SERVICE_REQUESTS.request_number - Номер заявки (REQ-XXXXXX)             ║
║ • SERVICE_REQUESTS.tracking_token - Токен для отслеживания клиентом       ║
╚═══════════════════════════════════════════════════════════════════════════╝

╔═══════════════════════════════════════════════════════════════════════════╗
║ ИНДЕКСЫ (Indexes)                                                         ║
╠═══════════════════════════════════════════════════════════════════════════╣
║ VEHICLES:                                                                 ║
║   • client_id          - Для поиска автомобилей клиента                   ║
║                                                                           ║
║ SERVICE_REQUESTS:                                                         ║
║   • status             - Для фильтрации по статусу                        ║
║   • request_number     - Для быстрого поиска по номеру                    ║
║   • tracking_token     - Для отслеживания заявки                          ║
║   • client_id          - Для поиска заявок клиента                        ║
║                                                                           ║
║ REQUEST_WORKS:                                                            ║
║   • request_id         - Для получения всех работ по заявке               ║
║                                                                           ║
║ REQUEST_STATUS_HISTORY:                                                   ║
║   • request_id         - Для получения истории заявки                     ║
╚═══════════════════════════════════════════════════════════════════════════╝

╔═══════════════════════════════════════════════════════════════════════════╗
║ КАСКАДНЫЕ ОПЕРАЦИИ (Cascade)                                              ║
╠═══════════════════════════════════════════════════════════════════════════╣
║ REQUEST_WORKS.request_id                                                  ║
║   → ON DELETE CASCADE: При удалении заявки удаляются все работы           ║
║                                                                           ║
║ REQUEST_STATUS_HISTORY.request_id                                         ║
║   → ON DELETE CASCADE: При удалении заявки удаляется история              ║
╚═══════════════════════════════════════════════════════════════════════════╝


┌──────────────────────────────────────────────────────────────────────────────┐
│                            ТИПЫ ДАННЫХ                                       │
└──────────────────────────────────────────────────────────────────────────────┘

UUID             Универсальный уникальный идентификатор (128 бит)
VARCHAR          Строка переменной длины
TEXT             Текст неограниченной длины
INT              Целое число (-2,147,483,648 до 2,147,483,647)
DECIMAL(10,2)    Десятичное число с фиксированной точностью
                 (до 99,999,999.99 - для денежных значений)
TIMESTAMP        Дата и время с точностью до микросекунд


┌──────────────────────────────────────────────────────────────────────────────┐
│                     БИЗНЕС-ЛОГИКА И ПРАВИЛА                                  │
└──────────────────────────────────────────────────────────────────────────────┘

1. АВТОМАТИЧЕСКАЯ ГЕНЕРАЦИЯ:
   • UUID для всех первичных ключей
   • Номер заявки (request_number) в формате REQ-XXXXXX
   • Токен отслеживания (tracking_token) для клиентов
   • Временные метки created_at и updated_at

2. РАСЧЕТ СТОИМОСТИ:
   • REQUEST_WORKS.total_price = quantity × unit_price
   • SERVICE_REQUESTS.total_amount = сумма всех REQUEST_WORKS.total_price

3. СТАТУСЫ ЗАЯВОК:
   • new           - Новая заявка
   • in_progress   - В работе
   • completed     - Завершена
   • cancelled     - Отменена

4. СТАТУСЫ ОПЛАТЫ:
   • unpaid        - Не оплачено
   • paid          - Оплачено

5. РОЛИ ПОЛЬЗОВАТЕЛЕЙ:
   • admin         - Администратор (полный доступ)
   • master        - Мастер (работа с заявками)

6. ОТСЛЕЖИВАНИЕ ПРОГРЕССА:
   • progress_percentage - процент выполнения заявки (0-100)
   • Обновляется вручную мастером

7. ИСТОРИЯ ИЗМЕНЕНИЙ:
   • Каждое изменение статуса записывается в REQUEST_STATUS_HISTORY
   • Сохраняется старый и новый статус
   • Фиксируется пользователь, внесший изменение
   • Используется для аудита и формирования таймлайна


┌──────────────────────────────────────────────────────────────────────────────┐
│                          БЕЗОПАСНОСТЬ                                        │
└──────────────────────────────────────────────────────────────────────────────┘

• Пароли хранятся в виде bcrypt-хэша (USERS.password_hash)
• UUID вместо инкрементных ID предотвращает перебор
• tracking_token позволяет клиентам отслеживать заявки без авторизации
• Индексы на критичных полях для защиты от DoS через медленные запросы


════════════════════════════════════════════════════════════════════════════════
                             КОНЕЦ ДОКУМЕНТА
════════════════════════════════════════════════════════════════════════════════
