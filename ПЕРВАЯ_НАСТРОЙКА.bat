@echo off
chcp 65001 >nul
title Car Lab - Первоначальная настройка

echo.
echo ════════════════════════════════════════════════════════════════════════════════
echo                   ПЕРВОНАЧАЛЬНАЯ НАСТРОЙКА "CAR LAB"
echo                         (выполняется ОДИН раз)
echo ════════════════════════════════════════════════════════════════════════════════
echo.
echo Этот скрипт:
echo   1. Установит все зависимости (npm install) для всех трех проектов
echo   2. Создаст таблицы в базе данных (Prisma migrate)
echo   3. Заполнит БД тестовыми данными (seed)
echo.
echo ⚠️  ВАЖНО: Перед запуском убедитесь что:
echo   • PostgreSQL запущен
echo   • База данных ilialox_crm создана
echo   • Файл backend\.env настроен (правильный пароль от PostgreSQL)
echo.
echo ════════════════════════════════════════════════════════════════════════════════
echo.
pause

echo.
echo ┌────────────────────────────────────────────────────────────────────────────┐
echo │ ШАГ 1/4: Установка зависимостей для BACKEND                               │
echo └────────────────────────────────────────────────────────────────────────────┘
echo.
cd /d %~dp0backend
call npm install
if %ERRORLEVEL% NEQ 0 (
    echo.
    echo ❌ ОШИБКА при установке зависимостей backend!
    echo.
    pause
    exit /b 1
)

echo.
echo ┌────────────────────────────────────────────────────────────────────────────┐
echo │ ШАГ 2/4: Установка зависимостей для CRM                                   │
echo └────────────────────────────────────────────────────────────────────────────┘
echo.
cd /d %~dp0crm
call npm install
if %ERRORLEVEL% NEQ 0 (
    echo.
    echo ❌ ОШИБКА при установке зависимостей CRM!
    echo.
    pause
    exit /b 1
)

echo.
echo ┌────────────────────────────────────────────────────────────────────────────┐
echo │ ШАГ 3/4: Установка зависимостей для PUBLIC SITE                           │
echo └────────────────────────────────────────────────────────────────────────────┘
echo.
cd /d %~dp0public-site
call npm install
if %ERRORLEVEL% NEQ 0 (
    echo.
    echo ❌ ОШИБКА при установке зависимостей Public Site!
    echo.
    pause
    exit /b 1
)

echo.
echo ┌────────────────────────────────────────────────────────────────────────────┐
echo │ ШАГ 4/4: Создание таблиц в базе данных (Prisma Migrate)                   │
echo └────────────────────────────────────────────────────────────────────────────┘
echo.
cd /d %~dp0backend
call npx prisma migrate dev --name init
if %ERRORLEVEL% NEQ 0 (
    echo.
    echo ❌ ОШИБКА при создании таблиц БД!
    echo Проверьте:
    echo   • PostgreSQL запущен
    echo   • База данных ilialox_crm создана
    echo   • Правильный пароль в backend\.env
    echo.
    pause
    exit /b 1
)

echo.
echo ┌────────────────────────────────────────────────────────────────────────────┐
echo │ ДОПОЛНИТЕЛЬНО: Заполнить БД тестовыми данными?                            │
echo └────────────────────────────────────────────────────────────────────────────┘
echo.
echo Хотите добавить тестовые данные (пользователя, клиентов, заявки)?
echo.
set /p SEED_CHOICE="Введите Y для заполнения или N чтобы пропустить: "

if /i "%SEED_CHOICE%"=="Y" (
    echo.
    echo Заполнение БД тестовыми данными...
    cd /d %~dp0backend
    call npm run seed
    if %ERRORLEVEL% NEQ 0 (
        echo.
        echo ⚠️  Ошибка при заполнении БД, но это не критично.
        echo Вы можете запустить это позже командой: npm run seed
    ) else (
        echo.
        echo ✅ Тестовые данные добавлены!
        echo.
        echo Данные для входа:
        echo   Email:    admin@ilialox.com
        echo   Password: admin123
    )
)

echo.
echo ════════════════════════════════════════════════════════════════════════════════
echo                              ✅ НАСТРОЙКА ЗАВЕРШЕНА!
echo ════════════════════════════════════════════════════════════════════════════════
echo.
echo Все зависимости установлены и база данных готова!
echo.
echo СЛЕДУЮЩИЙ ШАГ: Запуск системы
echo   Используйте файл: ЗАПУСК_ВСЕХ_СЕРВЕРОВ.bat
echo.
echo   ИЛИ вручную в трех терминалах:
echo     1. cd backend       + npm run dev
echo     2. cd crm           + npm run dev
echo     3. cd public-site   + npm run dev
echo.
echo ════════════════════════════════════════════════════════════════════════════════
echo.

pause
